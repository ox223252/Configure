#!/bin/bash
# Copyright (C) 2018 name of ox223252
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#

INSTALL=

MAX_X=$(tput cols)
MAX_Y=$(tput lines)

WIDTH=60
HEIGH=20
LINES=12

configFolder=".config"

dataLibs=("pthread" \
	"sdl.1" \
	"sdl.2" \
	"realTime" \
	"math" \
	"ssl" \
	"cares" \
	"crypto" \
	"use_DLL" \
	"create_DLL" \
	)
dataLibsValues=("-lpthread" \
	"-lSDL" \
	"-lSDL2" \
	"-lrt" \
	"-lm" \
	"-lssl" \
	"-lcares" \
	"-lcrypto" \
	"-ldl" \
	"-shared" \
	)
archTest=("HARD_ARCH" \
	"MODE" \
	"WARNING" \
	"GPROF" \
	"GDB" \
	"LINKAGE" \
	"OUT_DLL" \
	"FLAGS" \
	)
warningType=( "std" \
	"none" \
	"all" \
	)
warningInfos=( "standard" \
	"no_warning" \
	"all_warnings" \
	)
outType=( "static" \
	"dynamic" \
	)
outInfos=( "binary" \
	"shared_lib" \
	)
debugTypes=( "GDB" \
	"GPROF" \
	"FULL_CPP" \
	)
linkageType=( "dynamic" \
	"static" \
	)
optimisationType=( "-O0" \
	"-O1" \
	"-O2" \
	"-O3" \
	)
optimisationInfo=( "none" \
	"minimal"
	"binary_size" \
	"execution_speed" \
	)
modeInfos=( "compiled_with_debug_logs" \
	"compiled_without_debug_log" \
	)
modeType=( "debug" \
	"release" \
	)
pathType=( "EXEC" \
	"OUTFOLDER" \
	"ROOT_DIR" \
	"DOC_DIR" \
	"SOURCE_DIR" \
	"PATCH_DIR" \
	"RESSOURCES_DIR" \
	"CONFIG_DIR" \
	"LIB_DIR" \
	)
pathValue=( "exec" \
	"out" \
	"bin" \
	"doc" \
	"src" \
	"patch" \
	"res" \
	"$configFolder" \
	"lib" \
	)
saveLast=4

#select default editor if no one configured
[ "$EDITOR" == "" ] && [ -f /bin/nano ] && EDITOR="nano"
[ "$EDITOR" == "" ] && [ -f /usr/bin/vi ] && EDITOR="vi"

#verification de la presence des paquet necessaires et proposition d'installation
PACKETS=" gcc g++ xutils-dev dialog curl"
for TMP in $PACKETS
do
	dpkg -s $TMP 2> .log 1> /dev/null
	if [ "$(cat .log)" != "" ]; then
		printf "\e[32m$TMP\e[0m is missing, you need it to continue.\n"
		echo "would you want to install it ? (Y/n)"
		read REP
		if [ "$REP" != "n" ] && [ "$REP" != "N" ]; then
			INSTALL+=" $TMP"
		fi
	fi
	rm .log
done

if [ "$INSTALL" != "" ]; then
	sudo apt-get install -y -f $INSTALL
fi

# si un fichier nomé .config existe on le supprime et on
# créait quoi qu'il arrive un dossier .config
tmpFile=/tmp/config_dialog

[ -f "$configFolder" ] && \
	rm $configFolder
[ ! -d "$configFolder" ] && \
	mkdir $configFolder

# path
if [ ! -f "$configFolder/config_path.mk" ]; then
	inputLength=${#pathType[@]}

	for (( i=0; i<${inputLength}; i++ ))
	do
		echo "${pathType[$i]}=${pathValue[$i]}" >> "$configFolder/config_path.mk"
	done
fi

# flags
configfile="$configFolder/config_tools_flags.mk"
[ ! -f "$configfile" ] && \
	echo "FLAGS+= -D'BY_LINUX_MAKEFILE'" > $configfile

# navtive tools
configfile="$configFolder/config_tools_natif.mk"
[ ! -f "$configfile" ] && \
	echo "CC=gcc" > $configfile && \
	echo "CXX=g++" >> $configfile

# cross tools
configfile="$configFolder/config_tools_cross.mk"
[ ! -f "$configfile" ] && \
		echo "LABEL=arm" > $configfile  && \
		echo "arm_CROSS_CC=arm-linux-gnueabi-gcc" >> $configfile && \
		echo "arm_CROSS_CXX=arm-linux-gnueabi-g++" >> $configfile && \
		echo "LABEL=w64" >> $configfile  && \
		echo "w64_CROSS_CC=i686-w64-mingw32-gcc" >> $configfile && \
		echo "w64_CROSS_CXX=i686-w64-mingw32-g++" >> $configfile

# hardware hard_arch (natif/cross)
configfile="$configFolder/config_options_hard_arch.mk"
[ ! -f "$configfile" ] && \
	echo "HARD_ARCH=natif" > $configfile

# work dir
configfile="$configFolder/config_path.mk"
[ ! -f "$configfile" ] && \
	echo "ROOT_DIR=bin" > $configfile && \
	echo "EXEC=exec" >> $configfile && \
	echo "OUTFOLDER=out" >> $configfile && \
	echo "SOURCE_DIR=src" >> $configfile && \
	echo "DOC_DIR=doc" >> $configfile && \
	echo "PATCH_DIR=patch" >> $configfile && \
	echo "RESSOURCES_DIR=res" >> $configfile && \
	echo "CONFIG_DIR=.config" >> $configfile && \
	echo "LIB_DIR=lib" >> $configfile

# patch save
configfile="$configFolder/config_options_patch.mk"
[ ! -f "$configfile" ] && \
	echo "PATCH=" > $configfile





# création du makefile
printMake () {
	echo "# Made by 0x223252" > makefile
	echo "# All rigth reserved" >> makefile

printf "include $configFolder/*

# project root folder
ifeq (\$(ROOT_DIR),)
	ROOT_DIR=.
endif
# source folder name
ifeq (\$(SOURCE_DIR),)
	SOURCE_DIR=src
endif
# exec folder name
ifeq (\$(OUTFOLDER),)
	OUTFOLDER=bin
endif
# exec file name
ifeq (\$(EXEC),)
	EXEC=exec
endif
# debug / release
ifeq (\$(MODE),)
	MODE=debug
endif

ifneq (\$(HARD_ARCH),natif)
	CXX=\$(\$(HARD_ARCH)_CROSS_CXX)
	CC=\$(\$(HARD_ARCH)_CROSS_CC)
	LDFLAGS+=\$(CROSS_LIB)
else
	LDFLAGS+=\$(LIB)
endif

ifeq (\$(MODE),release)
	FLAGS+= -D'MODE_RELEASE'
else
	FLAGS+= -D'MODE_DEBUG'
endif

ifeq (\$(LINKAGE),static)
	LDFLAGS+= -static
endif

ifeq (\$(OUT_DLL),dynamic)
	FLAGS+= -fPIC
	LDFLAGS+= -shared -fPIC
endif

ifeq (\$(WARNING),all)
	FLAGS+= -Wall -Wshadow -Wextra -fexceptions
else ifeq (\$(WARNING), none)
	FLAGS+= -w
endif

ifeq (\$(GPROF),on)
	FLAGS+= -pg
	LDFLAGS+= -pg
endif

ifeq (\$(GDB),on)
	FLAGS+= -g
	LDFLAGS+= -g
endif

" >> makefile

inputLength=${#archTest[@]}

for (( i=0; i<${inputLength}; i++ ))
do
	echo "LAST_${archTest[$i]}=null" >> makefile
	echo "LAST_${archTest[$i]}=\$(shell [ -f \".last_config\" ] && cat .last_config | grep ^${archTest[$i]} | cut -d '=' -f2-)" >> makefile
	echo "EQ_${archTest[$i]}=\$(shell [ -f \".last_config\" ] && [ \"\$(${archTest[$i]})\" = \"\$(LAST_${archTest[$i]})\" ] && echo true)" >> makefile
	echo "" >> makefile
	echo "ifneq (\$(EQ_${archTest[$i]}),true)" >> makefile
	echo "	DEPEND=mrproper" >> makefile
	echo "endif" >> makefile
	echo "" >> makefile
done

inputLength=${#dataLibs[@]}

for (( i=0; i<${inputLength}; i++ ))
do
	echo "ifeq (\$(${dataLibs[${i}]}),on)" >> makefile
	echo "	LDFLAGS+= ${dataLibsValues[${i}]}" >> makefile
	echo "endif" >> makefile
	echo "" >> makefile
done

printf "ifeq (\$(FULL_CPP),on)
	CC=\$(CXX)
endif

CPP_SRC=\$(shell find ./\$(SOURCE_DIR) -name *.cpp)
CPP_OBJ=\$(CPP_SRC:.cpp=.o)

C_SRC=\$(shell find ./\$(SOURCE_DIR) -name *.c)
C_OBJ=\$(C_SRC:.c=.o)

OBJ=\$(C_OBJ) \$(CPP_OBJ)

all: testVar \$(ROOT_DIR) cible \$(DEPEND) makedeps \$(ROOT_DIR)/\$(EXEC) \$(CONFIG) \$(ROOT_DIR)/\$(OUTFOLDER)
	@echo \"+=======================================+\"
	@echo \"|	\\\\033[1;92mBuid done\\\\033[0m\\t\\t\\t|\"
	@printf \"| for hard_arch : \\\\033[1;92m%s\\\\033[0m   \\t\\t|\" \$(shell file \$(ROOT_DIR)/\$(EXEC) | cut -d ',' -f2)
	@echo \"| in : \\\\033[1;92m\$(MODE)\\\\033[0m mode \t\t\t|\"
	@echo \"+=======================================+\"

testVar:
	@echo \"assert input var, do not remove this else it should be \\\\033[1;31mdangerous\\\\033[0m\"
" >> makefile

inputLength=${#pathType[@]}

for (( i=0; i<${inputLength}; i++ ))
do
	echo "ifeq (\$(${pathType[${i}]}),)" >> makefile
	echo "	@echo \"\\\\033[1;91m${pathType[${i}]}: \$(${pathType[${i}]}) not valide\\\\033[0m\"" >> makefile
	echo "	@exit 1" >> makefile
	echo "endif" >> makefile
	echo "ifeq (\$(${pathType[${i}]}),/)" >> makefile
	echo "	@echo \"\\\\033[1;91m${pathType[${i}]}: \$(${pathType[${i}]}) not valide\\\\033[0m\"" >> makefile
	echo "	@exit 1" >> makefile
	echo "endif" >> makefile
done

printf "	@echo \"\\\\033[1;92mVar tests valides, continue\\\\033[0m\"

\$(ROOT_DIR):
	@\$(shell [ -d \"\$(ROOT_DIR)\" ] || mkdir -p \"\$(ROOT_DIR)\" )

\$(ROOT_DIR)/\$(OUTFOLDER): \$(ROOT_DIR)
	@\$(shell [ ! -d \"\$(ROOT_DIR)/\$(OUTFOLDER)\" ] && mkdir -p \"\$(ROOT_DIR)/\$(OUTFOLDER)\" )

cible:
	@echo  > .last_config
" >> makefile

inputLength=${#archTest[@]}

for (( i=0; i<${inputLength}; i++ ))
do
	echo "	@echo \"${archTest[$i]}=\$(${archTest[$i]})\" >> .last_config" >> makefile
done
echo >> makefile

printf "docs:
	@doxywizard doc/Doxyfile

\$(ROOT_DIR)/\$(EXEC): \$(OBJ)
	\$(CXX) -o \$@ \$^ \$(LDFLAGS)

%%.o: %%.c
	\$(CC) -c -o \$@ \$< \$(FLAGS) -DDATE_BUILD=\\\"\\\\\"\$(shell date +'%%Y.%%m.%%d %%H:%%M:%%S')\\\\\"\\\"
%%.o: %%.cpp
	\$(CXX) -c -o \$@ \$< \$(FLAGS) -DDATE_BUILD=\\\"\\\\\"\$(shell date +'%%Y.%%m.%%d %%H:%%M:%%S')\\\\\"\\\"


clean:
	rm -f \$(shell find ./\$(SOURCE_DIR)/ -name *.o) \$(shell find ./\$(SOURCE_DIR)/ -name *.so)

cleanDoc:
	rm -f -r doc/html/*
	rm -f -r doc/latex/*
	rm -f -r doc/xml/*
	rm -f -r doc/man/*
	rm -f -r doc/rtf/*

cleanDump:
	rm -f -r \$(ROOT_DIR)/\$(OUTFOLDER)/*

mrproper: clean cleanDump cleanDoc
	rm -f \$(ROOT_DIR)/\$(EXEC)

empty: mrproper
	@echo \"#!/bin/bash\" > script.sh
	@echo \'rm -r \$\$(ls -a | grep -v -E \\\"(^((\.+)|(Configure)|(configure)" >> makefile

inputLength=${#pathType[@]}
for (( i=$saveLast; i<${inputLength}; i++ ))
do
	printf "|(\$(${pathType[$i]}))" >> makefile
done
printf ")\$\$|(^\.git)|(^README)|(^readme))\\\")\' >> script.sh
	
	@cat script.sh | grep rm

	@chmod +x script.sh
	@./script.sh

makedeps:
	@makedepend -Y \$(C_SRC) \$(CPP_SRC) 2> /dev/null

\$(CONFIG):
	@[ ! -f \$(CONFIG) ] && echo > \$(CONFIG)

printEnv:
" >> makefile

inputLength=${#archTest[@]}

for (( i=0; i<${inputLength}; i++ ))
do
	echo "	@echo \"LAST_${archTest[$i]}=\$(LAST_${archTest[$i]})\"" >> makefile
	echo "	@echo \"${archTest[$i]}=\$(${archTest[$i]})\"" >> makefile
	echo "	@echo \"EQ_${archTest[$i]}=\\033[1;93m\$(EQ_${archTest[$i]})\\033[0m\"" >> makefile
done
}

[ ! -f makefile ] && printMake && exit

checkWindow ()
{
	# $1 title
	# $2 winType
	# $3 config file
	# $4 cancel
	# $5 inputs

	title=$1
	winType=$2
	configfile=$3
	cancel=$4

	input=($5)

	if [ "$winType" != "checklist" ]; then
		return
	fi

	if [ "$cancel" != "--nocancel" ]; then
		cancel="--cancel-label $cancel"
	fi

	values=()

	configfile=$3

	inputLength=${#input[@]}

	PARAMS=""

	for (( i=0; i<${inputLength}; i++ ))
	do
		if [ -f "$configfile" ]; then
			tmp=$(cat $configfile | grep ${input[$i]})
			if [ "$tmp" != "" ]; then
				values[${i}]=$(echo $tmp | cut -d '=' -f2)
			else
				values[${i}]="off"
			fi
		else
			values[${i}]="off"
		fi

		# save params
		PARAMS="$PARAMS $i ${input[$i]} ${values[$i]}"

		# reset all params
		values[${i}]="off"
	done

	dialog $cancel \
		--checklist \
		"$title" \
		$HEIGH \
		$WIDTH \
		$LINES \
		$PARAMS 2> $tmpFile

	parameters=$(cat $tmpFile)

	for item in $parameters
	do
		values[${item}]="on"
	done

	echo > $configfile
	for (( i=0; i<${inputLength}; i++ ))
	do
		echo "${input[$i]}=${values[$i]}" >> $configfile
	done
}

selectWinodw ()
{
	# $1 title
	# $2 winType
	# $3 config file
	# $4 cancel
	# $5 ID
	# $6 options
	# $7 comment

	title=$1
	winType=$2
	configfile=$3
	cancel=$4
	ID=$5

	input=($6)
	info=($7)

	if [ "$winType" != "radiolist" ]; then
		return
	fi

	if [ "$cancel" != "--nocancel" ]; then
		cancel="--cancel-label $cancel"
	fi

	values=()
	active=$(cat $configfile | grep $ID | cut -d '=' -f2)

	inputLength=${#input[@]}

	PARAMS=""

	for (( i=0; i<${inputLength}; i++ ))
	do
		if [ "$active" == "${input[$i]}" ]; then
			value[${i}]="on"
		else
			value[${i}]="off"
		fi

		PARAMS="$PARAMS $i ${info[$i]} ${value[$i]}"
	done

	dialog $cancel \
		--radiolist \
		"$title" \
		$HEIGH \
		$WIDTH \
		$LINES \
		$PARAMS 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	if [ "$ID=${input[$choice]}" != "" ]; then
		echo "$ID=${input[$choice]}" > $configfile
	else
		echo "$ID=${input[0]}" > $configfile
	fi
}

editWindow ()
{
	# $1 ID
	# $2 config file
	# $default values
	ID=($1)
	configfile=$2
	values=($3)

	if [ ! -f "$configfile" ]; then
		inputLength=${#ID[@]}

		echo "" > $configfile

		for (( i=0; i<${inputLength}; i++ ))
		do
			echo "${ID[$i]}=${values[$i]}" >> $configfile
		done
	fi

	$EDITOR -c $configfile
}

tool_natif ()
{
	configfile="$configFolder/config_tools_natif.mk"
	[ ! -f "$configfile" ] && echo "CC=gcc" > $configfile && echo "CXX=g++" >> $configfile
	items=$(awk -F\= '{print $1,$2}' $configfile)
	dialog --menu "Natif" $HEIGH $WIDTH $LINES $items 2> $tmpFile

	retval=$?
	parameter=$(cat $tmpFile)

	[ $retval -eq 0 ] && tochange=$parameter || return 1

	val=$(awk -F\= -v x=$tochange '$1==x {print $2}' $configfile)
	dialog --inputbox "Enter new value($tochange)" 0 0 $val 2> $tmpFile

	dialog --title "Confirmation"  --yesno "Commit ?" 0 0
	case $? in
		0) 	newval=$(cat $tmpFile)
			awk -v x=$tochange -v n=$newval ' BEGIN {FS=OFS="="}$1==x {$2=n} {print} ' $configfile > $configfile.tmp
			mv $configfile.tmp $configfile
			;;
		1|255) dialog --infobox "No Changes done" 0 0
			sleep 2
			;;
	esac
	dialog --textbox $configfile 0 0
}

tool_cross ()
{
	configfile="$configFolder/config_tools_cross.mk"

	[ ! -f "$configfile" ] &&
		echo "LABEL=arm" > $configfile  &&
		echo "arm_CROSS_CC=arm-linux-gnueabi-gcc" >> $configfile &&
		echo "arm_CROSS_CXX=arm-linux-gnueabi-g++" >> $configfile &&
		echo "LABEL=w64" >> $configfile  &&
		echo "w64_CROSS_CC=i686-w64-mingw32-gcc" >> $configfile &&
		echo "w64_CROSS_CXX=i686-w64-mingw32-g++" >> $configfile

	values=()
	labels=($(cat $configfile | grep LABEL | cut -d '=' -f2 ))

	inputLength=${#labels[@]}

	PARAMS=""

	for (( i=0; i<${inputLength}; i++ ))
	do
		PARAMS="$PARAMS $i ${labels[$i]}"
	done
	PARAMS="$PARAMS $i New"

	dialog --cancel-label "Back" \
		--menu "Cross tools chaine" $HEIGH $WIDTH $LINES \
			$PARAMS 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	case $choice in
		$i)
			nano $configfile
			;;
		*)
			# echo "HARD_ARCH=${labels[$i]}" > $configFolder/config_options_hard_arch.mk
			;;
	esac
}

tools ()
{
	dialog --cancel-label "Back" \
		--menu "Tools chaine" $HEIGH $WIDTH $LINES \
			1 "libs" \
			2 "flags" \
			3 "Natives tools" \
			4 "Additional natives libs" \
			5 "Cross tools" \
			6 "Additional cross libs " 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	case $choice in
		1) 	checkWindow \
				"debug option" \
				"checklist" \
				"$configFolder/config_tools_libs.mk" \
				"--nocancel" \
				"${dataLibs[*]}"
			tools
			;;
		2) 	editWindow \
				"A_FLAGS" \
				"$configFolder/config_tools_flags.mk"
			tools
			;;
		3) 	tool_natif
			tools
			;;
		4) 	editWindow \
				"LIB" \
				"$configFolder/config_tools_natif_lib.mk"
			tools
			;;
		5) 	tool_cross
			tools
			;;
		6) 	editWindow \
				"CROSS_LIB" \
				"$configFolder/config_tools_cross_lib.mk"
			tools
			;;
	esac
}

options_hard_arch ()
{
	configfile="$configFolder/config_options_hard_arch.mk"
	[ ! -f "$configfile" ] && echo "HARD_ARCH=natif" > $configfile
	active=$(cat $configfile | grep HARD_ARCH | cut -d '=' -f2)

	labelfile="$configFolder/config_tools_cross.mk"
	[ -f "$labelfile" ] && crossTool=($(cat $labelfile | grep LABEL | cut -d '=' -f2))

	natif="off"
	case $active in
		natif)
			natif="on"
			;;
	esac

	inputLength=${#crossTool[@]}

	PARAMS="0 natif $natif"
	for (( i=0; i<${inputLength}; i++ ))
	do
		if [ "$active" == "${crossTool[$i]}" ]; then
			PARAMS="$PARAMS "$(( $i + 1 ))" ${crossTool[$i]} on"
		else
			PARAMS="$PARAMS "$(( $i + 1 ))" ${crossTool[$i]} off"
		fi
	done

	echo $PARAMS

	dialog --cancel-label "Back" \
		--radiolist "choix de la cible de compilation" $HEIGH $WIDTH $LINES \
		$PARAMS 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	echo $choice

	case $choice in
		''|0)	echo "HARD_ARCH=natif" > $configfile
			natif="on"
			;;
		*)	choice=$(( $choice - 1 ))
			echo "HARD_ARCH="${crossTool[$choice]} > $configfile
			natif="off"
			;;
	esac
	echo $natif


	if [ "$natif" == "off" ]; then
		configfile="$configFolder/config_tools_cross.mk"
		CROSS_CC=$(cat $configfile | grep ${crossTool[$choice]}_CROSS_CC | cut -d '=' -f2)
		CROSS_CXX=$(cat $configfile | grep ${crossTool[$choice]}_CROSS_CXX | cut -d '=' -f2)

		INSTALL=""

		if [ "$CROSS_CC" == "arm-linux-gnueabi-gcc" ]; then
			dpkg -s gcc-arm-linux-gnueabi 2> .log 1> /dev/null
			if [ "$(cat .log)" != "" ]; then
				echo "gcc-arm is missing, you need it to continue."
				echo "would you want to install it ? (Y/n)"
				read INSTALL_GCC_ARM
				if [ $INSTALL_GCC_ARM != "n" ] && [ $INSTALL_GCC_ARM != "N" ]; then
					INSTALL+=" gcc-arm-linux-gnueabi"
				fi
			fi
			rm .log
		fi

		if [ "$CROSS_CXX" == "arm-linux-gnueabi-g++" ]; then
			dpkg -s g++-arm-linux-gnueabi 2> .log 1> /dev/null
			if [ "$(cat .log)" != "" ]; then
				echo "g++-arm is missing, you need it to continue."
				echo "would you want to install it ? (Y/n)"
				read INSTALL_GCC_ARM
				if [ $INSTALL_GCC_ARM != "n" ] && [ $INSTALL_GCC_ARM != "N" ]; then
					INSTALL+=" g++-arm-linux-gnueabi"
				fi
			fi
			rm .log
		fi

		if [ "$CROSS_CXX" == "i686-w64-mingw32-gcc" ] ||
			[ "$CROSS_CXX" == "i686-w64-mingw32-g++" ]; then
			dpkg -s mingw-w64 2> .log 1> /dev/null
			if [ "$(cat .log)" != "" ]; then
				echo "/gccg++-w64 is missing, you need it to continue."
				echo "would you want to install it ? (Y/n)"
				read INSTALL_GCC_ARM
				if [ $INSTALL_GCC_ARM != "n" ] && [ $INSTALL_GCC_ARM != "N" ]; then
					INSTALL+=" mingw-w64"
				fi
			fi
			rm .log
		fi

		if [ "$INSTALL" != "" ]; then
			echo "sudo apt-get install $INSTALL"
			sudo apt-get install $INSTALL
		fi
	fi
}

options_patch ()
{
	configfile="$configFolder/config_options_patch.mk"
	[ ! -f "$configfile" ] && echo "PATCH=" > $configfile
	active=$(cat $configfile | grep PATCH | cut -d '=' -f2)

	incremental="off"
	differentiel="off"
	decremental="off"
	case $active in
		incremental)
			incremental="on"
			;;
		differentiel)
			differentiel="on"
			;;
		decremental)
			decremental="on"
			;;
	esac
	dialog --cancel-label "Back" \
		--radiolist "type d'optimisation" $HEIGH $WIDTH $LINES \
		1 "incremental" $incremental\
		2 "differentiel" $differentiel\
		3 "decremental" $decremental 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	case $choice in
		1)	echo "PATCH=incremental" > $configfile
			;;
		2)	echo "PATCH=differentiel" > $configfile
			;;
		3)	echo "PATCH=decremental" > $configfile
			;;
		*)	echo "PATCH=" > $configfile
			;;
	esac
}

options ()
{
	hard_arch=''
	warning=''
	optimisation=''
	[ -f "$configFolder/config_options_hard_arch.mk" ] &&  hard_arch=$(cat "$configFolder/config_options_hard_arch.mk" | grep HARD_ARCH | cut -d '=' -f2)
	[ -f "$configFolder/config_options_warning.mk" ] &&  warning=$(cat "$configFolder/config_options_warning.mk" | grep WARNING | cut -d '=' -f2)
	[ -f "$configFolder/config_options_optimisation.mk" ] &&  optimisation=$(cat "$configFolder/config_options_optimisation.mk" | grep OPTIMISATION | cut -d '=' -f2)
	[ -f "$configFolder/config_options_linkage.mk" ] &&  linkage=$(cat "$configFolder/config_options_linkage.mk" | grep LINKAGE | cut -d '=' -f2)
	[ -f "$configFolder/config_options_outType.mk" ] &&  out=$(cat "$configFolder/config_options_outType.mk" | grep OUT_DLL | cut -d '=' -f2)

	dialog --cancel-label "Back" \
		--menu "Options de compilation" $HEIGH $WIDTH $LINES \
			1 "Hardware arch : "$hard_arch \
			2 "Warnning : "$warning \
			3 "Optimisation : "$optimisation \
			4 "Linkage : "$linkage \
			5 "Debug" \
			6 "out : "$out 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	case $choice in
		1) 	options_hard_arch
			options
			;;
		2) # warning
			selectWinodw \
				"niveau de warnings" \
				"radiolist" \
				"$configFolder/config_options_warning.mk" \
				"Back" \
				"WARNING" \
				"${warningType[*]}" \
				"${warningInfos[*]}"
			options
			;;
		3) # optimisation
			selectWinodw \
				"type d'optimisation" \
				"radiolist" \
				"$configFolder/config_options_optimisation.mk" \
				"Back" \
				"OPTIMISATION" \
				"${optimisationType[*]}" \
				"${optimisationInfo[*]}"
			options
			;;
		4) # linkage
			selectWinodw \
				"type de linkage" \
				"radiolist" \
				"$configFolder/config_options_linkage.mk" \
				"Back" \
				"LINKAGE" \
				"${linkageType[*]}" \
				"${linkageType[*]}"
			options
			;;
		5) # debug
			checkWindow \
				"debug option" \
				"checklist" \
				"$configFolder/config_options_debug.mk" \
				"Back" \
				"${debugTypes[*]}"
			options
			;;
		6) # binaire
			selectWinodw \
				"type de binaire produit" \
				"radiolist" \
				"$configFolder/config_options_outType.mk" \
				"Back" \
				"OUT_DLL" \
				"${outType[*]}" \
				"${outInfos[*]}"
			options
			;;
	esac
}

mode ()
{
	configfile="$configFolder/config_mode.mk"
	[ ! -f "$configfile" ] && echo "MODE=debug" > $configfile
	mode=$(cat $configfile | grep MODE | cut -d '=' -f2)

	debug="off"
	release="off"
	case $mode in
		debug)
			debug="on"
			;;
		release)
			release="on"
			;;
	esac
	dialog --cancel-label "Back" \
		--radiolist "mode de sortie" 20 61 5 \
		1 "compilé sans aucun log de debug" $release\
		2 "compilé avec les logs de debug affichable" $debug 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	case $choice in
		1)	echo "MODE=release" > $configfile
			;;
		2)	echo "MODE=debug" > $configfile
			;;
	esac
}

patch ()
{
	sleep 1
}

main ()
{
	dialog --cancel-label "Exit" \
		--title "$1" \
		--menu "Compilation Configuration" $HEIGH $WIDTH $LINES \
			1 "Tool chaine" \
			2 "Options" \
			3 "Path" \
			4 "Mode" \
			5 "Patch" \
			6 "Git" \
			7 "Build" 2> $tmpFile

	retv=$?
	choice=$(cat $tmpFile)

	if [ $retv -eq 1 -o $retv -eq 255 ]; then
		rm $tmpFile
		clear
		echo "update makefile [Y/n] ?"
		read scan

		if [ "$scan" != "n" ] || [ "$scan" != "N" ]; then
			rm makefile
			printMake
		fi
		exit
	fi


	case $choice in
		1)
			tools
			main
			;;
		2)
			options
			main
			;;
		3)
			editWindow \
				"${pathType[*]}" \
				"$configFolder/config_path.mk" \
				"${pathValue[*]}"
			main
			;;
		4)
			selectWinodw \
				"mode de sortie" \
				"radiolist" \
				"$configFolder/config_mode.mk" \
				"Back" \
				"MODE" \
				"${modeType[*]}" \
				"${modeInfos[*]}"
			main
			;;
		5)
			patch
			main
			;;
		6)
			clear
			for (( i=0; i < $MAX_Y / 2; i++ ))
			do
				echo "";
			done

			read -p "git repos owner name ? " gitUser
			read -p "where git repos should be cloned ? " gitSrc
			./$0_getGit -u $gitUser -s $gitSrc
			;;
		7)
			clear
			echo "update makefile [Y/n] ?"
			read scan

			if [ "$scan" != "n" ] || [ "$scan" != "N" ]; then
				rm makefile
				printMake
			fi

			make
			echo "press [Enter] to continue"
			read scan
			main
			;;
	esac
}

main $0
